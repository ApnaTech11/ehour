<project xmlns:artifact="antlib:org.apache.maven.artifact.ant" 
	name="eHourStandaloneDist" default="archive" basedir=".">
	<description>
		Builds eHour standalone dist file (don't mention Maven's assembly plugin..)
	</description>

	<property name="version" value="0.9.0-SNAPSHOT" />

	<property name="base" location="dist" />
	<property name="dist" location="${base}/standalone/ehour-${version}" />
	<property name="lib" location="${dist}/lib" />
	<property name="app" location="${dist}/app" />
	<property name="bin" location="${dist}/bin" />
	<property name="conf" location="${dist}/conf" />
	<property name="i18n" location="${dist}/resources/i18n" />

	<path id="maven-ant-tasks.classpath" path="lib/maven-ant-tasks-2.1.1.jar" />
	<typedef resource="org/apache/maven/artifact/ant/antlib.xml"
			uri="antlib:org.apache.maven.artifact.ant"
		   	classpathref="maven-ant-tasks.classpath" />

	<target name="init" depends="clean">
		<mkdir dir="${basedir}" />
		<mkdir dir="${dist}" />
		<mkdir dir="${lib}" />
		<mkdir dir="${app}" />
		<mkdir dir="${bin}" />
		<mkdir dir="${conf}" />
		<mkdir dir="${dist}/log" />
        <mkdir dir="${i18n}" />
	</target>
	
	<target name="dist" depends="init">
		<artifact:pom id="pom" file="eHour-standalone/pom.xml">
			<profile id="standalone" />
			<profile id="prod" />
		</artifact:pom>
		
		<artifact:dependencies filesetid="dependency.fileset" pomRefid="pom" scopes="compile, runtime" />
<!--
		<artifact:dependencies filesetId="dependency.fileset" scopes="compile,runtime">
			<dependency groupId="net.rrm.ehour" artifactId="eHour-standalone" version="${version}" scope="compile" />
			<pom file="eHour-standalone/pom.xml" scope="compile" />
		</artifact:dependencies>
-->

		<copy todir="${lib}">
			 <fileset refid="dependency.fileset" />
			 <mapper type="flatten" />
		</copy>

		<copy todir="${app}">
			 <fileset dir="eHour-web/src/main/webapp" excludes=".svn"/>
		</copy>

		<copy todir="${bin}">
			 <fileset dir="eHour-standalone/src/dist/prod/bin" excludes=".svn"/>
		</copy>

		<chmod dir="${bin}/" includes="**/*.sh" perm="ugo+rx" />
		<chmod dir="${bin}/" includes="**/wrapper" perm="ugo+rx" />

		<copy todir="${conf}">
			<fileset dir="eHour-standalone/src/dist/prod/conf" excludes=".svn" />
		</copy>

		<copy todir="${i18n}">
		    <fileset dir="eHour-wicketweb/src/dist/i18n" excludes=".svn" />
		</copy>

		<copy todir="${dist}">
			<fileset dir="src/assembly/txt/common" excludes=".svn" />
			<fileset dir="src/assembly/txt/standalone" excludes=".svn" />
		</copy>
	</target>

	<target name="archive" depends="dist">
		<zip destfile="${base}/ehour-${version}-standalone.zip" basedir="${dist}/.." />
	</target>

	<target name="clean">
		<delete dir="${dist}"  />
	</target>

</project>

